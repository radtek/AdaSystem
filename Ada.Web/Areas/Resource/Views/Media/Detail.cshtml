@using System.Web.Optimization
@using Ada.Core.Domain
@using Ada.Core.Infrastructure
@using Ada.Core.Tools
@using Ada.Core.ViewModel.Resource
@using Ada.Services.Business
@using Ada.Services.Resource
@model Ada.Core.Domain.Resource.Media
@{
    ViewBag.Title = Model.MediaName + " 详情";
    ViewBag.Bread = new List<SelectListItem>() { new SelectListItem() { Text = "查询资源", Value = Url.Action("Index") } };
    var service = EngineContext.Current.Resolve<IMediaService>();
    var orderservice = EngineContext.Current.Resolve<IOrderDetailCommentService>();
    MediaCommentView view1 = new MediaCommentView()
    {
        MediaId = Model.Id,
        limit = 20
    };
    MediaCommentView view2 = new MediaCommentView()
    {
        MediaId = Model.Id,
        limit = 20
    };
    var comments = service.LoadComments(view1);
    var ordercomments = orderservice.LoadComments(view2);
}
@Html.Partial("Bread")


<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row m-b-lg m-t-lg">
        <div class="col-md-6">

            <div class="profile-image">
                @if (string.IsNullOrWhiteSpace(Model.MediaLogo))
                {
                    <i class="fa @Model.MediaType.Image fa-5x"></i>
                }
                else
                {
                    <img src="@Model.MediaLogo" class="img-circle circle-border m-b-md" alt="profile">
                }
            </div>
            <div class="profile-info">
                <div class="">
                    <div>
                        <h2 class="no-margins">
                            @Model.MediaName

                        </h2>
                        @*@if (!string.IsNullOrWhiteSpace(Model.Area))
                            {
                                <small class='label label-info'><i class='fa fa-map-marker'></i> @Model.Area</small>
                            }*@
                        <h4>@Model.Abstract</h4>
                        <small>
                            @Model.Content
                        </small>

                        <div class='p-xxs'>
                            @foreach (var tag in Model.MediaTags.Take(6))
                            {
                                <span class='label label-success'><i class='fa fa-tag'></i> @tag.TagName</span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <table class="table small m-b-xs">
                <tbody>
                    <tr>

                        <td>
                            <strong>@Utils.ShowFansNum(Model.FansNum)</strong> 粉丝数(万)
                        </td>
                        <td>
                            <strong>@Model.MediaPrices.Sum(d => d.BusinessOrderDetails.Count)</strong> 交易次数
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <strong>@Model.MediaPrices.Sum(d => d.BusinessOrderDetails.Where(a => a.Status == Consts.StateOK).Sum(o => o.SellMoney))</strong> 成交金额
                        </td>
                        <td>
                            <strong>@Model.MediaPrices.Sum(d => d.PurchaseOrderDetails.Where(a => a.Status == Consts.PurchaseStatusSuccess).Sum(o => o.PurchaseMoney))</strong> 采购金额
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>



    </div>


    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    @{
                        var invalid = Model.MediaPrices.FirstOrDefault()?.InvalidDate?.ToString("yyyy-MM-dd");
                    }
                    <h3>资源报价 <small>价格有效期：@invalid</small></h3>

                </div>
                <div class="ibox-content">
                    <div class="row">
                        @foreach (var item in Model.MediaPrices)
                        {
                            <div class="col-lg-2">

                                <div class="widget  p-xs text-center">
                                    <div class="m-b-md">
                                        <h2 class="m-xs text-danger"><i class="fa fa-jpy"></i> @item.PurchasePrice</h2>
                                        <h3 class="font-bold no-margins">
                                            @item.AdPositionName
                                        </h3>
                                    </div>
                                </div>
                            </div>
                        }

                    </div>
                </div>
            </div>
        </div>
    </div>
    @if (Model.MediaArticles.Any())
    {
        if (Model.MediaType.CallIndex == "weixin")
        {
            @Html.Partial("WeiXinArticles", Model)
        }
        if (Model.MediaType.CallIndex == "sinablog")
        {
            @Html.Partial("WeiboArticles", Model)
        }
        if (Model.MediaType.CallIndex == "douyin")
        {
            @Html.Partial("DouYinArticles", Model)
        }

    }



    <div class="row">
        <div class="col-lg-6">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>满意度评价</h5>
                    <div class="ibox-tools">
                        @{

                            var avg2 = view2.AvgScore != null ? Math.Round((double)view2.AvgScore, 1) : 0;
                        }
                        <span class="label label-warning-light">综合评分 @avg2</span>
                    </div>
                </div>
                <div class="ibox-content">

                    @if (view2.total > 0)
                    {
                        <div>
                            <div class="feed-activity-list">

                                @foreach (var item in ordercomments)
                                {
                                    <div class="feed-element">
                                        <a href="#" class="pull-left">
                                            @{
                                                var image = string.IsNullOrWhiteSpace(item.TransactorImage) ? "/Images/noheader.png" : item.TransactorImage;
                                            }
                                            <img alt="image" class="img-circle" src="@image">
                                        </a>
                                        <div class="media-body">
                                            <small class="pull-right">@Utils.ToRead(item.CommentDate)</small>
                                            <strong>@item.Transactor</strong> @item.Organization <br>
                                            <small>
                                                @for (int i = 0; i < item.Score; i++)
                                                {
                                                    <i class="fa fa-star text-danger"></i>
                                                }
                                                @for (int i = 0; i < 5 - item.Score; i++)
                                                {
                                                    <i class="fa fa-star text-muted"></i>
                                                }


                                            </small>
                                            <div class="well">
                                                @item.Content
                                            </div>

                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            暂无相关评论信息
                        </div>
                    }

                </div>
            </div>

        </div>

        <div class="col-lg-6">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>配合度评价</h5>
                    <div class="ibox-tools">
                        @{

                            var avg1 = view1.AvgScore != null ? Math.Round((double)view1.AvgScore, 1) : 0;
                        }
                        <span class="label label-warning-light">综合评分 @avg1</span>
                    </div>
                </div>
                <div class="ibox-content">
                    @if (view1.total > 0)
                    {
                        <div>
                            <div class="feed-activity-list">

                                @foreach (var item in comments)
                                {
                                    <div class="feed-element">
                                        <a href="#" class="pull-left">
                                            @{
                                                var image = string.IsNullOrWhiteSpace(item.TransactorImage) ? "/Images/noheader.png" : item.TransactorImage;
                                            }
                                            <img alt="image" class="img-circle" src="@image">
                                        </a>
                                        <div class="media-body">
                                            <small class="pull-right">@Utils.ToRead(item.CommentDate)</small>
                                            <strong>@item.Transactor</strong> @item.Organization <br>
                                            <small>
                                                @for (int i = 0; i < item.Score; i++)
                                                {
                                                    <i class="fa fa-star text-danger"></i>
                                                }
                                                @for (int i = 0; i < 5 - item.Score; i++)
                                                {
                                                    <i class="fa fa-star text-muted"></i>
                                                }


                                            </small>
                                            <div class="well">
                                                @item.Content
                                            </div>

                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            暂无相关评论信息
                        </div>
                    }


                </div>
            </div>

        </div>
    </div>
</div>
@section StylesFirst {
    <meta name="referrer" content="never">
}
@section Styles {
    @Styles.Render("~/plugins/footableV3Styles")
}
@section Scripts {
    @Scripts.Render("~/plugins/footableV3")
    @Scripts.Render("~/plugins/echarts")
    <script>
        @if (Model.MediaArticles.Any())
        {
            <text>
                $(function () {
                    $('.table').footable();
                    initCharts();
                });
            </text>
        }


    </script>
}
